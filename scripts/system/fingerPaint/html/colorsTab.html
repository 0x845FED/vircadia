<!--Note: change the parent postmessage second parameter due to possible security issues-->
<link rel="stylesheet" type="text/css" href="../../html/css/colpick.css">
<script src="../../html/js/jquery-2.1.4.min.js"></script>
<style>
    #color_picker {
        display: grid;
    }
    .color_picker_cell {
        border: none; 
        width: 20px; 
        height: 20px;
    }
    #color_picker_table {
        border-collapse:collapse
    }
    #custom_color_picker {
        height: 50px;
    }
</style>
<div id="colorpicker"></div>
<table id="color_picker_table">
</table>
<div id="last_picked_colors"></div>
<div id="property-color" class="color-picker"></div>


<script src="../../html/js/colpick.js">
    require('jquery-colpick');
</script>
<script>
    $('#colorpicker').colpick({
        flat:true, 
        layout:'hex',
        colorScheme:'dark',
        submitText: 'Add custom color',
        onChange: function(hsb, hex, rgb, el) {
            update([rgb.r, rgb.g, rgb.b])
        },
        onSubmit: function(hsb, hex, rgb, el) {
            updateColorFromCustomPicker(rgb)
        }
    });

    var COLUMNS = 18, ROWS = 10;

    function addColors() {
        //10-90%
        var startingColors = [];
        for (var i = 0; i < COLUMNS; i++) {
            var hsl = new Object();
            hsl.hue = 340*i/(COLUMNS-1) + 10;
            startingColors.push(hsl);
        }
        var colorPickerLayout = document.getElementById("color_picker_table");
        for (var j = 0; j < ROWS; j++) {
            var row = document.createElement("tr");
            for (var i = 0; i < startingColors.length; i++) {
                var colorCell = document.createElement("input");
                colorCell.type = "button";
                colorCell.style.backgroundColor = "hsl(" + startingColors[i].hue + ",100%," + ((80-(80*j/(ROWS-1))) + 10) + "%)";
                colorCell.className  = "color_picker_cell";
                colorCell.onclick = function() { 
                    updateColorFromTable(this) 
                };
                row.appendChild(colorCell);
            }
            colorPickerLayout.appendChild(row);
        }
    }

    addColors();

    function update(colorArray) {
        // 'jscolor' instance can be used as a string
        var changedColorEvent = {
            "type"  : "changeColor",
            "red"   : colorArray[0],
            "green" : colorArray[1],
            "blue"  : colorArray[2]
        };
        parent.postMessage(JSON.stringify(changedColorEvent), "*");
    }

    function updateColorFromTable(button) {
        var colorArray = window.getComputedStyle(button).backgroundColor.match(/\d+/g); 
        $('#colorpicker').colpickSetColor({'r': colorArray[0], 'g': colorArray[1], 'b': colorArray[2]}, true);
        update(colorArray);
    }

    function updateColorFromCustomPicker(rgbColor) {
        var colorArray = [rgbColor.r, rgbColor.g, rgbColor.b];
        addCustomColor(colorArray, true);
        update(colorArray);
    }

    function addCustomColor(colorArray, notify) {
        var lastPickedColorsContainer = document.getElementById("last_picked_colors");
        var lastPickedColors = lastPickedColorsContainer.children;
        for (var i = 0; i < lastPickedColors.length; i++) {
            var lasPickedCellColor = window.getComputedStyle(lastPickedColors[0]).backgroundColor.match(/\d+/g);
            var equalRgbComponentsCount = 0; 
            for (var j = 0; j < 3; j++) {
                if (lasPickedCellColor[j] == colorArray[j])
                    equalRgbComponentsCount++;
                if (equalRgbComponentsCount == 3) //the color is the same so we won't add it!
                    return;
            }
        }
        if (lastPickedColors.length + 1 >= COLUMNS) {
            lastPickedColorsContainer.removeChild(lastPickedColors[lastPickedColors.length-1]);
        }
        var colorCell = document.createElement("input");
        colorCell.type = "button";
        colorCell.style.backgroundColor = "rgb(" + colorArray[0] + "," + colorArray[1] + "," + colorArray[2];
        colorCell.className  = "color_picker_cell";
        colorCell.onclick = function() { updateColorFromTable(this) };
        lastPickedColorsContainer.insertBefore(colorCell, lastPickedColorsContainer.firstChild);
        if (notify) {
             var addCustomColorEvent = {
                "type"     : "addCustomColor",
                "maxColors": COLUMNS,
                "red"      : colorArray[0],
                "green"    : colorArray[1],
                "blue"     : colorArray[2]
            };
            parent.postMessage(JSON.stringify(addCustomColorEvent), "*");
        }
    }

    window.addEventListener("message", restoreLastColor, false);
    function restoreLastColor(event) {
        var color = JSON.parse(event.data);
        var newColor = color.currentColor;
        var customColors = color.customColors;
        if (newColor) {
            $('#colorpicker').colpickSetColor({'r': newColor.red, 'g': newColor.green, 'b': newColor.blue}, true);    
        }
        if (customColors) {
            for (var i = 0; i < customColors.length; i++) {
                addCustomColor([customColors[i].red, customColors[i].green, customColors[i].blue], false);
            }
        }
    }
</script>